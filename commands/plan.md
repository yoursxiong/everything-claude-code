---
description: 重新阐述需求，评估风险，并创建逐步实现计划。在动代码之前必须先等用户确认。
---

# Plan 指令

此指令调用 **planner** 智能体，在编写任何代码之前创建一个全面的实现计划。

## 此指令的作用

1. **重新阐述需求** - 澄清需要构建的内容
2. **识别风险** - 发现潜在的问题和阻碍
3. **创建步骤计划** - 将实现过程分解为各个阶段
4. **等待确认** - 在继续操作之前**必须**获得用户的批准

## 何时使用

在以下情况下使用 `/plan`：
- 开始一个新功能
- 进行重大的架构调整
- 进行复杂的重构
- 涉及多个文件/组件时
- 需求不明确或存在歧义时

## 工作原理

planner 智能体将会：

1. **分析请求**并用清晰的术语重新阐述需求
2. **分解为多个阶段**，并附带具体、可操作的步骤
3. **识别组件之间的依赖关系**
4. **评估风险**和潜在的阻碍
5. **评估复杂度** (高/中/低)
6. **展示计划**并等待你的明确确认

## 使用示例

```
用户: /plan 我需要添加市场结算时的实时通知

智能体 (planner):
# 实现计划：实时市场结算通知

## 需求重新陈述
- 当用户关注的市场结算时，向其发送通知
- 支持多个通知渠道 (应用内、电子邮件、Webhook)
- 确保通知交付的可靠性
- 包含市场结果和用户的头寸损益情况

## 实现阶段

### 第 1 阶段：数据库方案
- 添加 `notifications` 表，包含列：`id`, `user_id`, `market_id`, `type`, `status`, `created_at`
- 添加 `user_notification_preferences` 表用于存储渠道偏好
- 为 `user_id` 和 `market_id` 创建索引以提高性能

### 第 2 阶段：通知服务
- 在 `lib/notifications.ts` 中创建通知服务
- 使用 BullMQ/Redis 实现通知队列
- 为失败的交付添加重试逻辑
- 创建通知模板

### 第 3 阶段：集成点
- 挂钩 (Hook) 市场结算逻辑 (当状态变更为 "resolved" 时)
- 查询在该市场中有头寸的所有用户
- 为每个用户将通知加入队列

### 第 4 阶段：前端组件
- 在顶栏中创建 `NotificationBell` 组件
- 添加 `NotificationList` 模态框
- 通过 Supabase 订阅实现实时更新
- 添加通知偏好设置页面

## 依赖项
- Redis (用于队列)
- 邮件服务 (SendGrid/Resend)
- Supabase 实时订阅

## 风险
- 高 (HIGH)：电子邮件的可送达性 (需要配置 SPF/DKIM)
- 中 (MEDIUM)：每个市场有超过 1000 名用户时的性能问题
- 中 (MEDIUM)：如果市场结算频繁，可能导致通知骚扰
- 低 (LOW)：实时订阅的开销

## 预计复杂度：中 (MEDIUM)
- 后端：4-6 小时
- 前端：3-4 小时
- 测试：2-3 小时
- 总计：9-13 小时

**等待确认**：是否按照此计划进行？(yes/no/modify)
```

## 重要注意事项

**严重**：planner 智能体在获得你明确的“yes”或“proceed”或类似的肯定回复之前，**不会**编写任何代码。

如果你想要调整，请回复：
- "modify: [你的变更内容]"
- "different approach: [另一种方案]"
- "跳过第 2 阶段，先做第 3 阶段"

## 与其他指令的集成

在计划之后：
- 使用 `/tdd` 通过测试驱动开发进行实现
- 如果发生构建错误，使用 `/build-and-fix`
- 使用 `/code-review` 审查完成的实现

## 相关智能体

此指令调用位于以下位置的 `planner` 智能体：
`~/.claude/agents/planner.md`
